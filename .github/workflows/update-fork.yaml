name: Update Fork

on:
  schedule:
    - cron:  "*/15 * * * *"
  workflow_dispatch:
    
jobs:
  update:  
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
  
      - name:  Set Up Git
        run: |
          git config --global user.email "northstarstaking@gmail.com"
          git config --global user.name "interruptRQ-c"
      
      - name:  Add Upstream Remote
        run: |
          git remote add upstream https://github.com/saekizm/pirateswap.git
      
      - name:  Fetch Upstream Changes
        run: |
          git fetch upstream
      
      - name:  Merge Upstream Changes
        run: |
          git checkout origin/main
          git rebase upstream/main

          for file in $(git diff --name-only --diff-filer=U); do
            if [ "$file" eq "update-fork.yaml" ]; then
              git checkout --ours "$file"
              git add "$file"
            else
              git checkout --theirs "$file"
              git add "$file"
            fi
            
          done

          #if [ -n "$(git status --porcelain)"]; then
          #  git diff
          #  git add .github/workflows/update-fork.yaml
          #  git add update-fork.yaml
          #  git rebase --continue
          #fi
          
          #git merge --allow-unrelated-histories upstream/main
          #git merge upstream/main
      
      - name:  Push Changes to Fork
        run: |
          # git pull
          if [ $? eq 0 ]; then
            echo "Already up to date";
            exit 0; # Exit without pushing
          else
            echo  "Local branch is ahead.  Proceeding with the push.";
            # git push origin main;
            exit 0;
          fi
